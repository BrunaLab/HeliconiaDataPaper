---
title: "Data validation with the pointblank package"
author: Eric R. Scott
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

This uses `pointblank` to create a data validation report. In the resulting table at the end, any failing tests should have a CSV button that lets you download a .csv file of just the rows of data that don't pass that particular validation step.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

library(pointblank)
library(pointblank)
library(readr)
library(here)
library(dplyr)
library(stringr)
# Use `validate_rmd()` here to set options for the
# pointblank validation workflow within R Markdown documents
```


```{r load-data}
ha <- read_csv(
  here("data_clean", "Ha_survey_pre_submission.csv"),
  col_types = cols(
    notes = col_character()
  )
)
```

**Action levels**

By default, warn if 1 or more rows fail conditions and error if 2% or more fail.  Some checks are run with a stricter action level that errors if *any* rows fail.

```{r al, echo=TRUE}
al_default <-  action_levels(warn_at = 1, stop_at = 0.02) #warn if even row fails, error if 2% of rows fail
al_strict <- action_levels(stop_at = 1) #error if even one row fails
```


```{r funs}
# Function for preconditions for some steps
calc_changes <- function(x) {
  x %>%
    group_by(HA_ID_Number) %>%
    arrange(HA_ID_Number, year) %>%
    mutate(ht_prev = lag(ht),
           shts_prev = lag(shts),
           ht_diff = ht - ht_prev,
           shts_diff = shts - shts_prev,
           ht_pc = abs(ht_diff / ht_prev),
           shts_pc = abs(shts_diff / shts_prev)) %>%
    ungroup()
}
```

# Data Validation

Checks for data type, range, and duplicates

```{r agent1}
ha %>%
  create_agent(
    actions = al_default,
    label = "Data Validation"
  ) %>%
  col_vals_in_set(vars(column), 1:10, actions = al_strict) %>%
  col_vals_in_set(vars(row), LETTERS[1:10], actions = al_strict) %>%
  col_vals_in_set(vars(habitat), c("1-ha", "CF", "10-ha"),
                  actions = al_strict) %>%
  col_vals_expr(label = "Height is measured to nearest cm",
                expr = ~ ht %% 1 == 0, actions = al_strict) %>%
  col_vals_expr(label = "Shoots is interger",
                expr = ~ shts %% 1 == 0, actions = al_strict) %>%
  col_vals_expr(label = "Number of inflorescences is integer",
                expr = ~ infl %% 1 == 0, actions = al_strict) %>% 
  # check values are within reasonable range
  col_vals_between(vars(shts), 1, 20, na_pass = TRUE,
                   label = "shoots between 1 and 20") %>%
  col_vals_between(vars(ht), 0, 200, na_pass = TRUE,
                   label = "height between 0 and 200cm") %>%
  col_vals_between(vars(infl), 0, 3, na_pass = TRUE,
                   label = "infloresences between 0 and 3") %>%
  rows_distinct(actions = al_strict, 
                label  = "duplicated rows") %>% 
  rows_distinct(columns = "HA_ID_Number",
                segments = vars(year),
                actions = al_strict,
                label = "Check for duplicate ID's within each year") %>% 
  interrogate()
```


# Year to year change

Checks that year to year change in size is reasonable

```{r agent2}
ha %>%
  create_agent(
    actions = al_default,
    label = "Check growth & regression"
  ) %>%
  
  # check that year-to-year change is reasonable
  col_vals_lt(vars(ht_pc), 2, na_pass = TRUE,
              preconditions = ~ . %>% calc_changes(),
              label = "|% change in height| < 200%") %>%
  col_vals_between(vars(ht_diff), -100, 100, na_pass = TRUE,
                   preconditions = ~. %>% calc_changes(),
                   label = "|∆ height| < 100cm",
                   actions = al_strict) %>%
  col_vals_between(vars(shts_diff), -5, 5, na_pass = TRUE,
                   preconditions = ~. %>% calc_changes(),
                   label = "|∆ shoot number| < 5",
                   actions = al_strict) %>%
  interrogate()
```

# Seedlings

Check that size of seedlings is reasonable

```{r agent3}
# check seedlings
ha %>%
  filter(sdlg_status == "sdlg (1)") %>% 
  create_agent(
    actions = al_strict,
    label = "Check seedlings"
  ) %>% 
  col_vals_lt(vars(shts), 3, na_pass = TRUE,
              label = "shoots < 3") %>% 
  col_vals_lt(vars(ht), 20, na_pass = TRUE,
              label = "height < 20cm") %>% 
  interrogate()
```
